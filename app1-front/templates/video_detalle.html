{% extends "base.html" %}

{% block title %}Video - {{ conductor['nombre'] }}{% endblock %}
{% block header %}Análisis de Video{% endblock %}

{% block header_actions %}
<div class="header-buttons">
    <form action="{{ url_for('reanalizar_video', video_id=video['id']) }}" method="POST" style="display: inline;">
        <input type="hidden" name="sample_rate" value="5">
        <button type="submit" class="btn btn-outline" onclick="this.disabled=true; this.innerHTML='Analizando...'; this.form.submit();">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Re-analizar
        </button>
    </form>
    <form action="{{ url_for('eliminar_video_route', video_id=video['id']) }}" method="POST" style="display: inline;" onsubmit="return confirm('¿Estás seguro de eliminar este video? Esta acción no se puede deshacer.');">
        <button type="submit" class="btn btn-danger">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Eliminar
        </button>
    </form>
</div>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('lista_conductores') }}">Conductores</a>
    <span>/</span>
    <a href="{{ url_for('detalle_conductor', conductor_id=conductor['id']) }}">{{ conductor['nombre'] }}</a>
    <span>/</span>
    <span>Video {{ video['fecha_grabacion'] or video['fecha_subida'][:10] }}</span>
</div>

<div class="video-analysis-container">
    <!-- Video Player -->
    <div class="video-player-section">
        <video id="analysis-video" controls class="video-player">
            <source src="{{ url_for('display_file', filename=video['filename']) }}" type="video/mp4">
            Tu navegador no soporta el elemento de video.
        </video>

        <!-- Timeline -->
        <div class="video-timeline">
            <div class="timeline-track" id="timeline-track">
                {% for inc in incidentes %}
                {% set start_pct = (inc['start_time'] / video['duracion_segundos'] * 100) if video['duracion_segundos'] else 0 %}
                {% set width_pct = ((inc['end_time'] - inc['start_time']) / video['duracion_segundos'] * 100) if video['duracion_segundos'] else 0 %}
                <div class="timeline-marker-incident"
                     style="left: {{ start_pct }}%; width: {{ width_pct if width_pct > 0.5 else 0.5 }}%;"
                     data-start="{{ inc['start_time'] }}"
                     data-end="{{ inc['end_time'] }}"
                     title="Incidente: {{ inc['start_time'] }}s - {{ inc['end_time'] }}s">
                </div>
                {% endfor %}
            </div>
            <div class="timeline-time">
                <span>0:00</span>
                <span>{{ '%d:%02d' | format((video['duracion_segundos'] or 0) // 60, (video['duracion_segundos'] or 0) % 60) }}</span>
            </div>
        </div>
    </div>

    <!-- Sidebar con info -->
    <div class="video-sidebar">
        <!-- Info General -->
        <div class="card">
            <div class="card-header compact">
                <h4>Información</h4>
            </div>
            <div class="card-body">
                <div class="info-list">
                    <div class="info-item">
                        <span class="info-label">Conductor</span>
                        <span class="info-value">{{ conductor['nombre'] }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fecha</span>
                        <span class="info-value">{{ video['fecha_grabacion'] or video['fecha_subida'][:10] }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Turno</span>
                        <span class="info-value">{{ video['turno'] | capitalize if video['turno'] else 'N/A' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Duración</span>
                        <span class="info-value">{{ '%d:%02d' | format((video['duracion_segundos'] or 0) // 60, (video['duracion_segundos'] or 0) % 60) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="card">
            <div class="card-header compact">
                <h4>Resultados</h4>
            </div>
            <div class="card-body">
                <div class="result-bars">
                    <div class="result-bar-item">
                        <div class="result-bar-header">
                            <span>Manejo Seguro</span>
                            <span class="text-success">{{ "%.1f" | format(video['porcentaje_safe'] or 0) }}%</span>
                        </div>
                        <div class="result-bar">
                            <div class="result-bar-fill safe" style="width: {{ video['porcentaje_safe'] or 0 }}%"></div>
                        </div>
                    </div>

                    <div class="result-bar-item">
                        <div class="result-bar-header">
                            <span>Texting</span>
                            <span class="text-danger">{{ "%.1f" | format(video['porcentaje_texting'] or 0) }}%</span>
                        </div>
                        <div class="result-bar">
                            <div class="result-bar-fill danger" style="width: {{ video['porcentaje_texting'] or 0 }}%"></div>
                        </div>
                    </div>

                    <div class="result-bar-item">
                        <div class="result-bar-header">
                            <span>Sin Detección</span>
                            <span class="text-muted">{{ "%.1f" | format(video['porcentaje_undefined'] or 0) }}%</span>
                        </div>
                        <div class="result-bar">
                            <div class="result-bar-fill neutral" style="width: {{ video['porcentaje_undefined'] or 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Incidentes -->
        <div class="card">
            <div class="card-header compact">
                <h4>Incidentes ({{ incidentes | length }})</h4>
            </div>
            <div class="card-body no-padding">
                {% if incidentes %}
                <div class="incident-list-compact">
                    {% for inc in incidentes %}
                    <div class="incident-item-compact" onclick="seekToTime({{ inc['start_time'] }})">
                        <div class="incident-number">#{{ loop.index }}</div>
                        <div class="incident-info-compact">
                            <span class="incident-time-range">
                                {{ '%d:%02d' | format(inc['start_time'] // 60, inc['start_time'] % 60) }} -
                                {{ '%d:%02d' | format(inc['end_time'] // 60, inc['end_time'] % 60) }}
                            </span>
                            <span class="incident-duration-compact">{{ inc['duracion'] }}s</span>
                        </div>
                        <button class="btn-icon" title="Ir al momento">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state-mini">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Sin incidentes detectados</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const video = document.getElementById('analysis-video');

function seekToTime(seconds) {
    video.currentTime = seconds;
    video.play();
}

// Click en timeline
document.querySelectorAll('.timeline-marker-incident').forEach(el => {
    el.addEventListener('click', function() {
        seekToTime(parseFloat(this.dataset.start));
    });
});

// Auto seek si hay param t en URL
const urlParams = new URLSearchParams(window.location.search);
const startTime = urlParams.get('t');
if (startTime) {
    video.addEventListener('loadedmetadata', function() {
        seekToTime(parseFloat(startTime));
    });
}
</script>
{% endblock %}
