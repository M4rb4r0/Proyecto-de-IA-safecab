{% extends "base.html" %}

{% block title %}{{ conductor['nombre'] }}{% endblock %}
{% block header %}{{ conductor['nombre'] }}{% endblock %}

{% block header_actions %}
<a href="{{ url_for('subir_video', conductor_id=conductor['id']) }}" class="btn btn-primary">+ Subir Video</a>
{% endblock %}

{% block content %}
<!-- Info del Conductor -->
<div class="conductor-profile">
    <div class="profile-avatar large">{{ conductor['nombre'][0] | upper }}</div>
    <div class="profile-info">
        <h2>{{ conductor['nombre'] }}</h2>
        <div class="profile-meta">
            {% if conductor['rut'] %}
            <span class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                RUT: {{ conductor['rut'] }}
            </span>
            {% endif %}
            <span class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Turno: {{ conductor['turno'] | capitalize }}
            </span>
        </div>
    </div>
</div>

<!-- Stats del Conductor -->
<div class="stats-row">
    <div class="stat-mini">
        <span class="stat-mini-value">{{ videos | length }}</span>
        <span class="stat-mini-label">Videos</span>
    </div>
    <div class="stat-mini">
        <span class="stat-mini-value text-danger">{{ incidentes | length }}</span>
        <span class="stat-mini-label">Incidentes</span>
    </div>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab active" data-tab="videos">Videos ({{ videos | length }})</button>
    <button class="tab" data-tab="incidentes">Incidentes ({{ incidentes | length }})</button>
</div>

<!-- Tab: Videos -->
<div class="tab-content active" id="tab-videos">
    {% if videos %}
    <div class="video-grid">
        {% for v in videos %}
        <a href="{{ url_for('ver_video', video_id=v['id']) }}" class="video-card">
            <div class="video-thumbnail">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
            </div>
            <div class="video-info">
                <span class="video-date">{{ v['fecha_grabacion'] or v['fecha_subida'][:10] }}</span>
                <span class="video-turno">Turno {{ v['turno'] or 'N/A' }}</span>
                <div class="video-stats">
                    <span class="{% if v['porcentaje_texting'] > 10 %}text-danger{% elif v['porcentaje_texting'] > 5 %}text-warning{% else %}text-success{% endif %}">
                        {{ "%.1f" | format(v['porcentaje_texting'] or 0) }}% texting
                    </span>
                    <span class="text-muted">&middot; {{ v['cantidad_incidentes'] or 0 }} incidentes</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5">
            <polygon points="23 7 16 12 23 17 23 7"></polygon>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
        </svg>
        <p>No hay videos analizados</p>
        <a href="{{ url_for('subir_video', conductor_id=conductor['id']) }}" class="btn btn-primary">Subir Primer Video</a>
    </div>
    {% endif %}
</div>

<!-- Tab: Incidentes -->
<div class="tab-content" id="tab-incidentes">
    {% if incidentes %}
    <div class="incidents-timeline">
        {% for inc in incidentes %}
        <div class="timeline-item {% if not inc['revisado'] %}unreviewed{% endif %}">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
                <div class="timeline-header">
                    <span class="timeline-date">{{ inc['fecha_grabacion'] or 'Sin fecha' }}</span>
                    {% if not inc['revisado'] %}
                    <span class="badge badge-warning">Pendiente</span>
                    {% endif %}
                </div>
                <div class="timeline-body">
                    <span class="incident-range">{{ inc['start_time'] }}s - {{ inc['end_time'] }}s</span>
                    <span class="incident-duration">({{ inc['duracion'] }}s de duraci√≥n)</span>
                </div>
                <div class="timeline-actions">
                    <a href="{{ url_for('ver_video', video_id=inc['video_id']) }}?t={{ inc['start_time'] }}" class="btn btn-sm btn-outline">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Ver Clip
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <p>No se han detectado incidentes</p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    });
});
</script>
{% endblock %}
